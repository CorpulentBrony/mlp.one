# http2 handles multiple requests well, inlining can actually harm performance
map $http2 $mlp_one_disable_filters {
	default "combine_css,combine_javascript,flatten_css_imports,inline_css,inline_google_font_css,inline_images,inline_import_to_link,inline_javascript";
	"" "";
}

# domain sharding in http2 is not recommended
map $http2 $mlp_one_domain_shards {
	default "";
	"" "https://static1.mlp.one,https://static2.mlp.one";
}

# http2 handles multiple requests well, outlining can actually improve performance
map $http2 $mlp_one_enable_filters {
	default "outline_css,outline_javascript";
	"" "";
}

server {
	listen *:443;
	listen [::]:443;
	server_name api.mlp.one;
	ssl_certificate /etc/letsencrypt/live/mlp.one-0001/fullchain.pem;
	ssl_certificate_key /etc/letsencrypt/live/mlp.one-0001/privkey.pem;
	ssl_trusted_certificate /etc/letsencrypt/live/mlp.one-0001/chain.pem;
	return 301 http://$host$request_uri;
}

server {
	include server.conf.d/pagespeed.conf;

	# from boilerplate.conf, excluding strict transport security directives
	more_set_headers "P3P: CP=\"This is not a P3P policy!  The P3P standard is deprecated.  Read more about P3P here: https://en.wikipedia.org/wiki/P3P\"";
	more_set_headers "X-Content-Type-Options: nosniff";
	more_set_headers "X-Frame-Options: sameorigin";
	more_set_headers "X-UA-Compatible: IE=Edge";
	more_set_headers "X-XSS-Protection: 1; mode=block";
	limit_conn conn_limit_per_ip 30;
	limit_req zone=req_limit_per_ip burst=50 nodelay;


	#set up content security policy
	set $csp_default "'self' api.mlp.one";
	# set $csp_child "child-src $csp_default";
	# set $csp_connect "connect-src $csp_default";
	# set $csp_font "font-src $csp_default";
	# set $csp_img "img-src $csp_default";
	# set $csp_script "script-src $csp_default";
	# set $csp_style "style-src $csp_default";
	more_set_headers "Content-Security-Policy: default-src $csp_default"; #; $csp_child; $csp_connect; $csp_font; $csp_img; $csp_script; $csp_style; upgrade-insecure-requests";
	more_set_headers "X-Best-Pony: Twilight Sparkle";
	listen *:80;
	listen [::]:80;
	etag on;
	if_modified_since before;
	pagespeed Domain http://api.mlp.one;
	pagespeed FileCachePath "/var/cache/httpd/mod_pagespeed/";
	server_name api.mlp.one;

	location = / { return 301 https://mlp.one; }
	location = /podcast.xsl { alias /var/www/html/api.mlp.one/podcast.xsl; }

	location / {
		proxy_cache api_mlp_one_cache;
		proxy_cache_background_update on;
		proxy_cache_lock on;
		proxy_cache_revalidate on;
		proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
		proxy_cache_valid 200 5s;
		proxy_connect_timeout 1s;
		proxy_hide_header "Alt-Svc";
		proxy_hide_header "Alternate-Protocol";
		proxy_hide_header "Cache-Control";
		proxy_hide_header "Content-Security-Policy";
		proxy_hide_header "Expires";
		proxy_hide_header Link;
		proxy_hide_header "Set-Cookie";
		proxy_hide_header "Strict-Transport-Security";
		proxy_hide_header "Vary";
		proxy_http_version 1.1;
		proxy_ignore_headers "Cache-Control" "Expires" "Set-Cookie" "Vary";
		proxy_intercept_errors on;
		proxy_pass_request_headers off;
		proxy_set_header Accept-Encoding "";

		location = /favicon.ico {
			proxy_cache_valid 200 1y;
			proxy_pass http://podcast.mlp.one/rss.png;
		}
		location = /podcast { proxy_pass https://mlp.one/api/podcast.php; }
		location = /podcast.rss { proxy_pass https://mlp.one/api/podcast.php; }
	}
}

server {
	include server.conf.d/*.conf;

	# site-wide variables
	set $siteDescription "Some anons from /mlp/ get together to discuss the show, fandom, and for general bants.  Please be patient, we have autism.";
	set $siteImage "//podcast.mlp.one/mlpodcast.png";
	set $siteKeywords "mlp, pone, 4chan, anon, podcast, my little pony, friendship is magic, brony";
	# set_secure_random_alphanum $siteNonce 32;
	set $siteThumbnail "$siteImage";
	set $siteTitle "/mlp/odcast";

	#set up content security policy
	set $csp_default "'self' *.mlp.one mlp.one";
	set $csp_child "child-src $csp_default smartlock.google.com";
	set $csp_connect "connect-src $csp_default";
	set $csp_font "font-src $csp_default fonts.gstatic.com";
	set $csp_img "img-src $csp_default blob: data: www.google-analytics.com www.gstatic.com";
	set $csp_media "media-src $csp_default blob:";
	set $csp_script "script-src $csp_default blob: data: accounts.google.com smartlock.google.com www.google-analytics.com 'unsafe-inline'";
	set $csp_style "style-src $csp_default fonts.googleapis.com 'unsafe-inline'"; # 'nonce-$siteNonce' 
	more_set_headers "Content-Security-Policy: default-src $csp_default; $csp_child; $csp_connect; $csp_font; $csp_img; $csp_media; $csp_script; $csp_style; upgrade-insecure-requests";
	more_set_headers "X-Best-Pony: Twilight Sparkle";
	listen *:443;
	listen [::]:443;
	etag on;
	if_modified_since before;
	index index.html index.php;
	# pagespeed AnalyticsID "UA-53253741-9";
	pagespeed Domain https://mlp.one;
	pagespeed FileCachePath "/var/cache/httpd/mod_pagespeed/";
	pagespeed MapRewriteDomain mlp.one www.mlp.one;
	pagespeed EnableFilters "$mlp_one_enable_filters";
	pagespeed DisableFilters "$mlp_one_disable_filters";
	pagespeed LoadFromFile "https://mlp.one/image/" "/var/www/html/mlp.one/image/";
	pagespeed LoadFromFile "https://mlp.one/index.css" "/var/www/html/mlp.one/index.css";
	pagespeed LoadFromFile "https://mlp.one/index.js" "/var/www/html/mlp.one/index.js";
	pagespeed MapProxyDomain "https://mlp.one/podcast/" "http://podcast.mlp.one.s3-website-us-east-1.amazonaws.com/";
	#pagespeed ShardDomain https://mlp.one "$mlp_one_domain_shards";
	root /var/www/html/mlp.one;
	server_name mlp.one www.mlp.one static1.mlp.one static2.mlp.one;
	ssi on;
	ssi_last_modified on;
	ssi_types "application/json" "application/ld+json" "application/manifest+json" "application/xml";
	ssl_certificate /etc/letsencrypt/live/mlp.one-0001/fullchain.pem;
	ssl_certificate_key /etc/letsencrypt/live/mlp.one-0001/privkey.pem;
	ssl_trusted_certificate /etc/letsencrypt/live/mlp.one-0001/chain.pem;
	# sub_filter_once off;
	# sub_filter ***CSP_NONCE*** $siteNonce;

	location /api/vendor { deny all; }
	location /conf { deny all; }
	location = / { add_header Link "<https://podcast.mlp.one>; rel=preconnect; pr=1"; }
	location = /index.html { add_header Link "<https://podcast.mlp.one>; rel=preconnect; pr=1"; }

	location = /api/podcast.php { include php_directives.conf; }
	location = /api/podcast-test.php { include php_directives.conf; }
	location = /api/podcast-html.php {
		include php_directives.conf;
		xml_entities /var/www/html/mlp.one/api/podcast.dtd;
		xslt_stylesheet /var/www/html/mlp.one/api/podcast-html.xsl;
		xslt_types application/xml application/rss+xml;
	}
	location = /api/podcast-schema.php {
		include php_directives.conf;
		xml_entities /var/www/html/mlp.one/api/podcast.dtd;
		xslt_stylesheet /var/www/html/mlp.one/api/podcast-schema.xsl;
		xslt_types application/xml application/rss+xml;
	}
	location = /api/podcast-sitemap.php {
		include php_directives.conf;
		xml_entities /var/www/html/mlp.one/api/podcast.dtd;
		xslt_stylesheet /var/www/html/mlp.one/api/podcast-sitemap.xsl;
		xslt_types application/xml application/rss+xml;
	}
	location = /build { deny all; }
	location = /manager/client_secrets.json { deny all; }
	location = /next_podcast_date.sh { deny all; }
	location = /sitemap.xml { return 301 https://mlp.one/api/podcast-sitemap.php; }
	location ^~ /manager {
		include php.conf;
	}
}